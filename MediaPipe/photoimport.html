<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video and Photo Processing with Logs</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            font-family: Arial, sans-serif;
        }
        #videoUpload, #imageUpload {
            margin-top: 20px;
        }
        #uploadedVideo, #outputCanvas, #uploadedImage {
            width: 100%;
            max-width: 600px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <input type="file" id="videoUpload" accept="video/*">
    <video id="uploadedVideo" controls></video>
    <input type="file" id="imageUpload" accept="image/*">
    <img id="uploadedImage">
    <canvas class="output_canvas" id="outputCanvas"></canvas>
    <br><br>
    <button id="downloadLogs">Télécharger les données</button>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <script>
        console.log('Script chargé');

        const videoElement = document.getElementById('uploadedVideo');
        const imageElement = document.getElementById('uploadedImage');
        const canvasElement = document.getElementById('outputCanvas');
        const canvasCtx = canvasElement.getContext('2d');

        let logs = [];
        let fileName = 'logs.txt';

        function downloadLogs() {
            const blob = new Blob(logs, { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName.replace(/\.[^/.]+$/, "") + '.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function onResults(results) {
            const logData = JSON.stringify(results);
            logs.push(logData);
            console.log('Résultats :', results);

            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

            if (results.segmentationMask) {
                canvasCtx.drawImage(results.segmentationMask, 0, 0, canvasElement.width, canvasElement.height);
                canvasCtx.globalCompositeOperation = 'source-in';
                canvasCtx.fillStyle = '#00FF00';
                canvasCtx.fillRect(0, 0, canvasElement.width, canvasElement.height);
                canvasCtx.globalCompositeOperation = 'destination-atop';
                canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
                canvasCtx.globalCompositeOperation = 'source-over';
            }

            if (results.poseLandmarks) {
                drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#00FF00', lineWidth: 4});
                drawLandmarks(canvasCtx, results.poseLandmarks, {color: '#FF0000', lineWidth: 2});
            }

            if (results.faceLandmarks) {
                drawConnectors(canvasCtx, results.faceLandmarks, FACEMESH_TESSELATION, {color: '#C0C0C070', lineWidth: 1});
            }

            if (results.leftHandLandmarks) {
                drawConnectors(canvasCtx, results.leftHandLandmarks, HAND_CONNECTIONS, {color: '#CC0000', lineWidth: 5});
                drawLandmarks(canvasCtx, results.leftHandLandmarks, {color: '#00FF00', lineWidth: 2});
            }

            if (results.rightHandLandmarks) {
                drawConnectors(canvasCtx, results.rightHandLandmarks, HAND_CONNECTIONS, {color: '#00CC00', lineWidth: 5});
                drawLandmarks(canvasCtx, results.rightHandLandmarks, {color: '#FF0000', lineWidth: 2});
            }

            canvasCtx.restore();
        }

        const holistic = new Holistic({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${file}`;
        }});
        holistic.setOptions({
            modelComplexity: 1,
            smoothLandmarks: true,
            enableSegmentation: true,
            smoothSegmentation: true,
            refineFaceLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });
        holistic.onResults(onResults);

        const videoUpload = document.getElementById('videoUpload');
        const imageUpload = document.getElementById('imageUpload');

        videoUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            fileName = file.name;
            const url = URL.createObjectURL(file);
            videoElement.src = url;

            videoElement.onloadeddata = () => {
                videoElement.play();
                canvasElement.width = videoElement.videoWidth;
                canvasElement.height = videoElement.videoHeight;
                processVideo(videoElement);
            };
        });

        imageUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            fileName = file.name;
            const url = URL.createObjectURL(file);
            imageElement.src = url;

            imageElement.onload = () => {
                canvasElement.width = imageElement.naturalWidth;
                canvasElement.height = imageElement.naturalHeight;
                processImage(imageElement);
            };
        });

        async function processVideo(video) {
            while (!video.paused && !video.ended) {
                await holistic.send({image: video});
                await new Promise(requestAnimationFrame);
            }
        }

        async function processImage(image) {
            await holistic.send({image: image});
        }

        document.getElementById('downloadLogs').addEventListener('click', downloadLogs);
    </script>
</body>
</html>
